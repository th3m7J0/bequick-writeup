from pwn import *
from PIL import Image
import numpy as np
from pyzbar.pyzbar import decode


r = remote('bequick.challs.shellmates.club', 1337)

r.recvline() # firstline

# 1- construct payload
qrcodeData = r.recvuntil("Decoded string:").decode()
payload = qrcodeData.replace('\x1b[7m  \x1b[0m','w').replace('\x1b[49m  \x1b[0m','b')[:-16]

# 2- construct qrcode

lines = payload.split('\n')

dotSize = 20

pixels =[]
for line in lines:
	data = [(255,255,255) if dot =="w" else (0,0,0) for dot in line]
	[pixels.append([pixel for pixel in data for _ in range(dotSize)]) for _ in range(dotSize)]

# Convert the pixels into an array using numpy
array = np.array(pixels, dtype=np.uint8)

# Use PIL to create an image from the new array of pixels
new_image = Image.fromarray(array)
#new_image.save('data.png')


# 3- decode qrcode
code = decode(new_image)[0].data.decode()
print('[+] qrcode content : {}'.format(code))
# 4- send code and get flag

r.sendline(code)
print(r.recvuntil("}").decode())

r.close()


